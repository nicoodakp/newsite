$(document).ready(function getWeather() {

  var lat;
  var lon;
  var timevar;
  var timevar1;
  var state;


  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(success, error);
  } else {
    alert("Geolocation services are not supported by your web browser.");
  }

  function success(position) {
    lat = position.coords.latitude;
    lon = position.coords.longitude;
    now = new Date().toISOString().slice(0,10);
    yesterday = new Date(new Date().setDate(new Date().getDate()-1)).toISOString().slice(0,10);



    var reversegeocodingapi = "https://maps.googleapis.com/maps/api/geocode/json?latlng="+lat+","+lon+"&key=AIzaSyBUySixqWTvfvEa6e0o_EZ_AVKkdNkRUzU";
    $.getJSON(reversegeocodingapi, function(place) {

      for (var i=0; i<place.results[0].address_components.length; i++) {
        if (place.results[0].address_components[i].types[0]==="locality") {
          var city = place.results[0].address_components[i].long_name;
          $("#city").html(city.toUpperCase());
        }
        if (place.results[0].address_components[i].types[0]==="administrative_area_level_1") {
          var state = place.results[0].address_components[i].long_name;
          $("#state").html(state.toUpperCase());
          }
      }

                                                                                                                // relevancy
  var url = 'https://newsapi.org/v2/everything?q='+state+'&from='+now+'&to='+yesterday+'&language=en'+'&sortBy=popularity'+'&apiKey=7db4796390474d78b54a008fcc708028'
      // var url = 'https://newsapi.org/v2/top-headlines?q='+state+'&sortBy=popularity&apiKey=7db4796390474d78b54a008fcc708028'
      // var url = 'https://newsapi.org/v2/everything?sources=vice-news&language=en&apiKey=7db4796390474d78b54a008fcc708028';

      var xhttp = new XMLHttpRequest();

      xhttp.onreadystatechange = function() {
        if ( this.readyState == 4 && this.status == 200 ) {
          var data = JSON.parse(xhttp.responseText).articles;

          console.log(data);

          var articles = data.map(mapToArticle);
          var contentDiv = document.getElementById('content');

          contentDiv.innerHTML = createTemplate(articles);
        }
      }

      xhttp.open("GET", url, true);
      xhttp.send();

      function mapToArticle(item) {
        return {
          url: item.url,
          title: item.title,
          author: item.author,
          date: item.publishedAt,
          img: item.urlToImage ? item.urlToImage : null,
          description: item.description
        };
      }

      function formatTime(timestr) {
        return timestr.substr(0, 10) + ' ';
      }

      function createTemplate(articles) {
        return articles.reduce(function(tmpl, article) {
          tmpl += `

          <article>

            <h2><a class="article-header" href="${article.url}">${article.title}</a></h2>
            <div class="row">
              <div class="col-md-4">
                <img class="img-fluid rounded mb-3" src="//images.weserv.nl/?url=${article.img}"  />
              </div>
              <div class="col-md-8">
                <p class="date">${formatTime(article.date)}</p>
                <p class="author">by ${article.author}</p>
                <div>${article.description}</div>
                <a class="btn-more" href="${article.url}">read more</a>
              </div>
            </div>
          </article>
          `;

          return tmpl;
        }, '');
      }
      var weatherapiurl = "https://api.darksky.net/forecast/693bfc720a2fc19b10c0d12926307eb7/"+lat+","+lon+"?callback=?"
      $.getJSON(weatherapiurl, function(weatherdata) {
        var tempf = Math.round(weatherdata.currently.temperature);
        $("#temp").html(tempf + "&deg;");
        var tempc = Math.round(((weatherdata.currently.temperature)-32)/(9/5));
        var feelslikef = Math.round(weatherdata.currently.apparentTemperature);
        $("#feels-like").html("Feels Like: " + feelslikef + "&deg;F");
        var feelslikec =  Math.round(((weatherdata.currently.apparentTemperature)-32)/(9/5));
        var summary = weatherdata.currently.summary;
        $("#weather-description").html(summary);
        //skycons
        var icon = weatherdata.currently.icon;
        var skycons = new Skycons({"color": "#ffffff"});
        skycons.set("weather-icon", icon);
        skycons.play();


        //3-DAY FORECAST
        //convert future dates (given in API by seconds since Jan 1 1970) to day of the week
        var weekday = ["Sun","Mon","Tue","Wed","Thur",
                  "Fri","Sat"]; //to find day of the week
        var dayArray = []; //to store days of the week
        var iconArray = []; //to store icon values
        var tempMaxArray = []; //to store max temps
        var tempMinArray = []; //to store min temps
        var precipArray = []; //to store precipitation probability
        //first, create function to get all the information
        function weatherInfo() {
          var time = weatherdata.daily.data[i].time;
          var date = new Date(time*1000);
          day = weekday[date.getDay()];
          dayArray.push(day);
          var weatherIcon = weatherdata.daily.data[i].icon;
          iconArray.push(weatherIcon);
          var tempMax = weatherdata.daily.data[i].temperatureMax;
          tempMaxArray.push(tempMax);
          var tempMin = weatherdata.daily.data[i].temperatureMin;
          tempMinArray.push(tempMin);
          var precip = weatherdata.daily.data[i].precipProbability;
          precipArray.push(precip);
        };
        //if it's before 6am (but after midnight), run the function as if later that day = "tomorrow" (so if it's 4am on a Sunday, Sunday will still show up as the first day in the forecast)
        var now = new Date();
        var hour = now.getHours();
        if (hour < 6) {
          for (var i=0; i<3; i++) {
            weatherInfo();
          };
        } else {
          for (var i=1; i<4; i++) {
            weatherInfo();
          };
        };

        //put weekdays into html
        $("#day2").html(dayArray[0]);
        $("#day3").html(dayArray[1]);
        $("#day4").html(dayArray[2]);
        //put icons into html
        skycons.set("weather-icon-day2", iconArray[0]);
        skycons.set("weather-icon-day3", iconArray[1]);
        skycons.set("weather-icon-day4", iconArray[2]);
        //put highs and lows into html
        $("#day2-high-low").html(Math.round(tempMaxArray[0]) + "/" + Math.round(tempMinArray[0])+"&deg;");
        $("#day3-high-low").html(Math.round(tempMaxArray[1]) + "/" + Math.round(tempMinArray[1])+"&deg;");
        $("#day4-high-low").html(Math.round(tempMaxArray[2]) + "/" + Math.round(tempMinArray[2])+"&deg;");
        //put chance of precipitation into html
        $("#day2-precip").html((Math.round(precipArray[0]*10)/10)*100 + "%");
        $("#day3-precip").html((Math.round(precipArray[1]*10)/10)*100 + "%");
        $("#day4-precip").html((Math.round(precipArray[2]*10)/10)*100 + "%");


        $("#fbutton").click(function(event) {
          $("#temp").html(tempf + "&deg;");
          $("#feels-like").html("Feels Like: " + feelslikef + "&deg;F");
          $("#day2-high-low").html(Math.round(tempMaxArray[0])+"/"+Math.round(tempMinArray[0])+"&deg;");
          $("#day3-high-low").html(Math.round(tempMaxArray[1])+"/"+Math.round(tempMinArray[1])+"&deg;");
          $("#day4-high-low").html(Math.round(tempMaxArray[2])+"/"+Math.round(tempMinArray[2])+"&deg;");
        });//end f click
      }); //end getJSON
    }); //end getJSON
// getWeatherData(lat, lon);
// getNewsData(st)
  } //end success


  function error() {
    var alerted = localStorage.getItem('alerted') || '';
    if (alerted != 'yes') {
     alert("Sorry, I don't know where you are, abort local news/weather service.");
     localStorage.setItem('alerted','yes');
    }

  }




}); //end ready
